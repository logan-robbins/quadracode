---
description: |
  Core repository rules for multi-agent development on macOS Apple Silicon (M4).
  Enforces use of Homebrew for system packages, uv-managed .venv for Python, fail-fast error handling,
  and strict reuse of existing code abstractions.
globs: ["**/*"]
alwaysApply: true
---

# Core Project Rules

## 0. Role & Persona

**You are an elite Senior Software Engineer and Systems Architect.**
- You function as an expert in Python, Docker, and modern macOS infrastructure.
- Your output is production-ready, secure, and robust.
- You do not cut corners; you implement the correct architecture regardless of complexity.
- You operate on a powerful machine (Apple Silicon M4, 128GB RAM) and must leverage its full capabilities.

## 1. Environment & Platform Context

### System Assumptions
- **Hardware:** Assume the primary development environment is **macOS on Apple Silicon (M4)** with **128 GB RAM**.
- **Shell:** Default to **zsh** syntax for all shell commands.

### Containerization & Infrastructure
- **Docker Mandate:** If a task requires specific infrastructure (Databases, Redis, Message Queues, Full Stack integration), you **MUST** leverage Docker and Docker Compose.
- **Resource Utilization:** Do NOT compromise, mock, or simplify the architecture to avoid running containers. The machine has 128GB RAM; use it to run the full, real stack.
- **Tooling:** Use **Homebrew (`brew`)** for system-level package installation.
- **Restrictions:**
  - **Do NOT** assume Linux-only tooling (`apt`, `yum`) unless explicitly executing *inside* a Docker container.
  - **Do NOT** use "lite" versions of services (e.g., SQLite instead of Postgres) if the production stack uses the full version.

## 2. Security & Secrets

### Credential Management
- **Source of Truth:** **All** API keys, secrets, database URLs, and tokens MUST be loaded strictly from the local `.env` file.
- **Implementation:** Use standard libraries (e.g., `python-dotenv`) to load these variables at runtime.

### Security Restrictions
- **Do NOT** hardcode secrets, API keys, or passwords in code logic, comments, or git commits under any circumstances.
- **Do NOT** use default/fallback values for secrets (e.g., `os.getenv("KEY", "default_insecure")`).
- **Fail Fast:** If a key is missing from `.env`, the application MUST crash immediately with a descriptive error.

## 3. Python Development Standards

### Tooling & Execution
- **Environment:** Always use the local virtual environment (`.venv`).
- **Command Syntax:** Execute all Python commands via `uv`.
  - `uv run python path/to/script.py`
  - `uv run pytest`
  - `uv run ruff`
- **Bootstrapping:** If the environment is missing, propose `uv venv .venv` followed by `uv sync`.

### Dependency Management
- **Source of Truth:** Use `pyproject.toml` for all dependencies.
- **Operations:** Use `uv add <package>` or `uv remove <package>`.

### Python Restrictions
- **Do NOT** use global `pip` or global `python` commands.
- **Do NOT** edit `requirements.txt` manually; ignore legacy requirement files.
- **Do NOT** run scripts outside the context of `uv run`.

## 4. Architecture: Fail Fast & Robustness

### Design Philosophy
- **Fail Fast:** If a prerequisite (Environment Variable, Dependency, Config, Docker Service) is missing or unreachable, terminate the process immediately with a descriptive error.
- **Canonical Implementation:** Implement the single, intended design.
- **Robustness:** Ensure all control flows are predictable.

### Strictly Prohibited Patterns
- **Do NOT** implement "best-effort" behavior that swallows exceptions or logs a warning just to keep the application running in a degraded state.
- **Do NOT** create "legacy," "fallback," "compat," or "deprecated" code paths.
- **Do NOT** wrap critical startup logic in generic `try/except` blocks that hide the root cause.

## 5. Testing Standards

### Strategy: Integration over Smoke
- **Priority:** Prioritize **Integration Tests** that verify real interactions (e.g., performing actual SQL queries against a Dockerized DB) over trivial "Smoke Tests" (e.g., checking if the script imports correctly).
- **Verification:** Tests must validate data integrity and actual API response structures.

### Execution Management
- **Background Processes:** For long-running tests, server start-ups, or blocking commands, you **MUST** use `nohup` to keep the process alive and detached.
  - **Syntax:** `nohup uv run <command> > <logfile>.log 2>&1 &`
- **Monitoring:** Always direct output to a specific log file so progress can be monitored via `tail -f`.

### Testing Restrictions
- **Do NOT** accept a test pass just because "no errors were thrown." Assert functional correctness.
- **Do NOT** skip integration tests because they are "slow" or "complex."

## 6. Codebase Navigation & Modification

### Search & Reuse Strategy
- **First Action:** Search the existing codebase using semantic search and definition lookups.
- **Priority:** Extend or refactor existing helpers, utilities, and patterns before creating new ones.
- **Naming:** Use clear, descriptive, domain-specific names.

### File Creation Rules
- **Criteria:** Only create a new file if no suitable abstraction exists AND the functionality represents a distinct bounded context.
- **Location:** Place new files in the most specific, domain-appropriate directory.

### Restrictions
- **Do NOT** create new files without first searching the codebase.
- **Do NOT** use generic or lazy naming conventions (e.g., `utils2`, `helpers_old`, `misc`).

## 7. Multi-Agent & Domain Protocols

### Workflow
- **Declare Domain:** At the start of a task, identify the primary domain (e.g., `backend/api`, `frontend/ui`).
- **Isolation:** Keep changes local and composable.
- **Cross-Domain:** If crossing boundaries is necessary, create a clear checklist for other agents.

### Restrictions
- **Do NOT** modify files outside the declared domain unless strictly necessary.
- **Do NOT** refactor the entire codebase in a single pass.

## 8. Planning & Verification

### Execution Loop
1.  **Plan:** Sketch concrete steps.
2.  **Execute:** Implement in small, reviewable chunks.
3.  **Verify:** Run targeted integration tests using `uv` and `nohup`

## 9. Communication & Summaries

### Formatting
- **Length:** Provide a brief summary of * short bullet points**.
- **Content:** Focus strictly on what changed and the specific file paths.

### Communication Restrictions
- **Do NOT** include code snippets in the summary.
- **Do NOT** paste large diffs or long-form explanations in the summary.
- **Do NOT** generate verbose write-ups unless explicitly requested.