x-python-env: &python-env
  MCP_REDIS_SERVER_URL: http://redis-mcp:8000/mcp/
  MCP_REDIS_TRANSPORT: streamable_http
  PYTHONUNBUFFERED: "1"
  QUADRACODE_LOG_LEVEL: ${QUADRACODE_LOG_LEVEL:-INFO}

x-python-service: &python-service
  env_file:
    - .env
    - .env.docker
  environment: *python-env
  volumes:
    - shared-data:/shared
    - mcp-remote-cache:/var/lib/mcp-remote
  restart: unless-stopped

x-orchestrator-base: &orchestrator-base
  <<: *python-service
  build:
    context: .
    dockerfile: quadracode-orchestrator/Dockerfile
  environment:
    <<: *python-env
    QUADRACODE_ID: orchestrator
    QUADRACODE_GRAPH_RECURSION_LIMIT: "200"
    QUADRACODE_DRIVER_MODEL: "anthropic:claude-sonnet-4-5-20250929"
  depends_on:
    redis:
      condition: service_healthy
    redis-mcp:
      condition: service_healthy
    agent-registry:
      condition: service_started
  volumes:
    - shared-data:/shared
    - mcp-remote-cache:/var/lib/mcp-remote
    - ./.env.docker:/app/quadracode-orchestrator/.env:ro

x-agent-base: &agent-base
  <<: *python-service
  build:
    context: .
    dockerfile: quadracode-agent/Dockerfile
  environment:
    <<: *python-env
    # QUADRACODE_ID is NOT set - agents auto-generate ephemeral IDs (agent-{uuid})
    QUADRACODE_GRAPH_RECURSION_LIMIT: "200"
    QUADRACODE_DRIVER_MODEL: "anthropic:claude-haiku-4-5"
  depends_on:
    redis:
      condition: service_healthy
    redis-mcp:
      condition: service_healthy
  volumes:
    - shared-data:/shared
    - mcp-remote-cache:/var/lib/mcp-remote
    - ./.env.docker:/app/quadracode-agent/.env:ro

services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s
    restart: unless-stopped

  redis-mcp:
    image: mcp/redis:latest
    command:
      [
        "uv",
        "run",
        "python",
        "-c",
        "from src.common.server import mcp; mcp.settings.host='0.0.0.0'; mcp.run('streamable-http')"
      ]
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; socket.create_connection(('127.0.0.1', 8000), timeout=2).close()"
        ]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 5s
    restart: unless-stopped

  agent-registry:
    <<: *python-service
    build:
      context: .
      dockerfile: quadracode-agent-registry/Dockerfile
    environment:
      <<: *python-env
      QUADRACODE_ID: agent-registry
    depends_on:
      redis:
        condition: service_healthy
      redis-mcp:
        condition: service_healthy
    ports:
      - "8090:8090"
    volumes:
      - shared-data:/shared
      - mcp-remote-cache:/var/lib/mcp-remote
      - ./.env.docker:/app/.env:ro
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8090/health', timeout=2)",
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 5s

  orchestrator:
    <<: *orchestrator-base
    ports:
      - "8123:8123"

  orchestrator-runtime:
    <<: *orchestrator-base
    command: ["python", "-m", "quadracode_orchestrator"]
    environment:
      <<: *python-env
      ENV_FILE_PATH: /app/.env.docker
      QUADRACODE_SCRIPTS_DIR: /app/scripts/agent-management
      AGENT_RUNTIME_PLATFORM: docker
      QUADRACODE_GRAPH_RECURSION_LIMIT: "200"
      QUADRACODE_DRIVER_MODEL: "anthropic:claude-sonnet-4-5-20250929"
      QUADRACODE_ID: orchestrator
    volumes:
      - shared-data:/shared
      - mcp-remote-cache:/var/lib/mcp-remote
      - ./.env.docker:/app/.env.docker:ro
      - ./scripts:/app/scripts:ro
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  agent:
    <<: *agent-base
    depends_on:
      redis:
        condition: service_healthy
      redis-mcp:
        condition: service_healthy
      orchestrator:
        condition: service_started
    ports:
      - "8124:8123"

  agent-runtime:
    <<: *agent-base
    environment:
      <<: *python-env
      # QUADRACODE_ID is NOT set - agent auto-generates ephemeral ID (agent-{uuid})
      QUADRACODE_GRAPH_RECURSION_LIMIT: "200"
      QUADRACODE_DRIVER_MODEL: "anthropic:claude-haiku-4-5"

    command: ["python", "-m", "quadracode_agent"]
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  human-clone-runtime:
    <<: *orchestrator-base
    command: ["python", "-m", "quadracode_runtime"]
    environment:
      <<: *python-env
      QUADRACODE_PROFILE: human_clone
      QUADRACODE_ID: human_clone
      QUADRACODE_GRAPH_RECURSION_LIMIT: "200"
    volumes:
      - shared-data:/shared
      - mcp-remote-cache:/var/lib/mcp-remote
      - ./.env.docker:/app/.env.docker:ro
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  workspace-default:
    image: python:3.12-slim
    container_name: qc-ws-default-ctr
    command: ["sleep", "infinity"]
    volumes:
      - qc-ws-default:/workspace
      - shared-data:/shared
    networks:
      - default

  ui:
    build:
      context: .
      dockerfile: quadracode-ui/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      agent-registry:
        condition: service_started
      orchestrator-runtime:
        condition: service_started
      workspace-default:
        condition: service_started
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      AGENT_REGISTRY_URL: http://agent-registry:8090
      UI_POLL_INTERVAL_MS: "2000"
      QUADRACODE_WORKSPACE_IMAGE: quadracode-workspace:latest
      QUADRACODE_WORKSPACE_NETWORK: quadracode_default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8501:8501"
    restart: unless-stopped

  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test-runner
    env_file:
      - .env
      - .env.docker
    environment:
      <<: *python-env
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      AGENT_REGISTRY_URL: http://agent-registry:8090
      MCP_REDIS_SERVER_URL: http://redis-mcp:8000/mcp/
      MCP_REDIS_TRANSPORT: streamable_http
      PYTHONPATH: /app
    depends_on:
      redis:
        condition: service_healthy
      redis-mcp:
        condition: service_healthy
      agent-registry:
        condition: service_started
      orchestrator-runtime:
        condition: service_started
      agent-runtime:
        condition: service_started
    volumes:
      - .:/app:ro
      - shared-data:/shared
      - mcp-remote-cache:/var/lib/mcp-remote
      - ./tests/logs:/app/tests/logs
      - ./tests/e2e_advanced/logs:/app/tests/e2e_advanced/logs
      - ./tests/e2e_advanced/metrics:/app/tests/e2e_advanced/metrics
      - ./tests/e2e_advanced/reports:/app/tests/e2e_advanced/reports
      - /var/run/docker.sock:/var/run/docker.sock  # Allow spawning sibling containers
    working_dir: /app
    command: ["sleep", "infinity"]  # Keep container running for test execution
    networks:
      - default

volumes:
  redis-data:
  shared-data:
  mcp-remote-cache:
  qc-ws-default:
