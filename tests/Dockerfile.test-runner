# Test runner container - runs tests with clear output for AI monitoring
FROM python:3.12-slim

# Set environment to reduce output noise
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy the entire project (tests need access to source code)
COPY . .

# Install Python dependencies directly
# Using pip since we're in a container and don't need uv's benefits here
RUN pip install --no-cache-dir \
    pytest==8.4.2 \
    redis==7.0.1 \
    requests==2.32.5 \
    python-dotenv==1.2.1 \
    anthropic==0.72.0 \
    langchain==0.3.27 \
    langchain-anthropic==0.3.22 \
    langchain-core==0.3.79 \
    langgraph==0.6.11 \
    langgraph-checkpoint==2.1.2 \
    pydantic==2.12.3 \
    structlog==25.5.0 \
    httpx==0.28.1 \
    asyncio \
    typing-extensions \
    jsonschema

# Make test runner executable
RUN chmod +x /app/tests/run_tests_in_container.py

# Set Python path to include source directories
ENV PYTHONPATH=/app:/app/quadracode-runtime/src:/app/quadracode-contracts/src:/app/quadracode-tools/src

# Default to running the test script
ENTRYPOINT ["python", "/app/tests/run_tests_in_container.py"]